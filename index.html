<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å­¦ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script type="module">
        import { Play, Pause, Square, Clock, TrendingUp, Target, User, LogOut, Calendar, BarChart3, Award, Flame } from 'https://cdn.skypack.dev/lucide-react';
        window.LucideIcons = { Play, Pause, Square, Clock, TrendingUp, Target, User, LogOut, Calendar, BarChart3, Award, Flame };
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Play, Pause, Square, Clock, TrendingUp, Target, User, LogOut, Calendar, BarChart3, Award, Flame } = window.LucideIcons;

        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyDT6UPrNLx-Gc6X5jmXfvEx9nljyoU6gcY",
          authDomain: "study-timer-4cf6c.firebaseapp.com",
          projectId: "study-timer-4cf6c",
          storageBucket: "study-timer-4cf6c.firebasestorage.app",
          messagingSenderId: "602384256321",
          appId: "1:602384256321:web:b44a4632cc830b5f2ee5c0"
        };

        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const StudyTimerApp = () => {
          const [user, setUser] = useState(null);
          const [isStudying, setIsStudying] = useState(false);
          const [isPaused, setIsPaused] = useState(false);
          const [currentSessionTime, setCurrentSessionTime] = useState(0);
          const [sessionStartTime, setSessionStartTime] = useState(null);
          const [pausedTime, setPausedTime] = useState(0);
          const [dailyRecords, setDailyRecords] = useState({});
          const [loading, setLoading] = useState(true);
          const [syncing, setSyncing] = useState(false);
          const [showLevelList, setShowLevelList] = useState(false);
          
          const intervalRef = useRef(null);

          const engineerLevels = [
            { name: 'å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ', hours: 0, color: '#e2e8f0', description: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼' },
            { name: 'Hello World', hours: 1, color: '#cbd5e1', description: 'æœ€åˆã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ãŸï¼' },
            { name: 'æ§‹æ–‡ç†è§£è€…', hours: 3, color: '#bfdbfe', description: 'åŸºæœ¬çš„ãªæ–‡æ³•ãŒåˆ†ã‹ã£ã¦ããŸ' },
            { name: 'å¤‰æ•°ãƒã‚¹ã‚¿ãƒ¼', hours: 5, color: '#93c5fd', description: 'å¤‰æ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç†è§£' },
            { name: 'æ¡ä»¶åˆ†å²ä½¿ã„', hours: 8, color: '#60a5fa', description: 'ifæ–‡ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‰ã‚Œã‚‹' },
            { name: 'ãƒ«ãƒ¼ãƒ—ä½¿ã„', hours: 12, color: '#3b82f6', description: 'for/whileæ–‡ãŒä½¿ãˆã‚‹' },
            { name: 'é–¢æ•°è·äººè¦‹ç¿’ã„', hours: 16, color: '#2563eb', description: 'é–¢æ•°ã‚’ä½œã£ã¦ä½¿ãˆã‚‹' },
            { name: 'é…åˆ—æ“ç¸¦å£«', hours: 20, color: '#1d4ed8', description: 'é…åˆ—ãƒ»ãƒªã‚¹ãƒˆã‚’æ“ä½œã§ãã‚‹' },
            { name: 'ãƒ‡ãƒãƒƒã‚°åˆå¿ƒè€…', hours: 25, color: '#1e40af', description: 'ã‚¨ãƒ©ãƒ¼ã‚’èª­ã‚“ã§ä¿®æ­£ã§ãã‚‹' },
            { name: 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å…¥é–€è€…', hours: 30, color: '#1e3a8a', description: 'ç°¡å˜ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç†è§£' },
            { name: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç†è§£è€…', hours: 35, color: '#10b981', description: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¯ãƒ©ã‚¹ã®åŸºæœ¬ã‚’ç†è§£' },
            { name: 'ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œè€…', hours: 40, color: '#059669', description: 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ããŒã§ãã‚‹' },
            { name: 'APIåˆä½“é¨“', hours: 45, color: '#047857', description: 'å¤–éƒ¨APIã‚’ä½¿ã£ã¦ã¿ãŸ' },
            { name: 'DOMæ“ä½œè€…', hours: 50, color: '#065f46', description: 'Webãƒšãƒ¼ã‚¸ã‚’å‹•çš„ã«å¤‰æ›´ã§ãã‚‹' },
            { name: 'ã‚¤ãƒ™ãƒ³ãƒˆä½¿ã„', hours: 55, color: '#064e3b', description: 'ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ã«åå¿œã§ãã‚‹' },
            { name: 'éåŒæœŸå…¥é–€', hours: 60, color: '#8b5cf6', description: 'éåŒæœŸå‡¦ç†ã®åŸºæœ¬ã‚’ç†è§£' },
            { name: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è§¦ã‚ŒãŸ', hours: 65, color: '#7c3aed', description: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åŸºæœ¬æ“ä½œãŒã§ãã‚‹' },
            { name: 'CRUDãƒã‚¹ã‚¿ãƒ¼', hours: 70, color: '#6d28d9', description: 'ä½œæˆãƒ»èª­å–ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãŒã§ãã‚‹' },
            { name: 'ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å…¥é–€', hours: 75, color: '#5b21b6', description: 'React/Vueãªã©ã«è§¦ã‚ŒãŸ' },
            { name: 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆè€…', hours: 80, color: '#4c1d95', description: 'å†åˆ©ç”¨å¯èƒ½ãªãƒ‘ãƒ¼ãƒ„ã‚’ä½œã‚Œã‚‹' },
            { name: 'ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç†è§£è€…', hours: 85, color: '#f59e0b', description: 'ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè£…ã§ãã‚‹' },
            { name: 'çŠ¶æ…‹ç®¡ç†å…¥é–€', hours: 90, color: '#d97706', description: 'stateã‚’é©åˆ‡ã«ç®¡ç†ã§ãã‚‹' },
            { name: 'ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°è·äºº', hours: 95, color: '#b45309', description: 'CSS/Tailwindã§ç¶ºéº—ã«è£…é£¾' },
            { name: 'ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œè€…', hours: 100, color: '#92400e', description: 'ã‚¹ãƒãƒ›ãƒ»PCã§è¦‹ã‚„ã™ã„ãƒšãƒ¼ã‚¸' },
            { name: 'Gitä½¿ã„', hours: 110, color: '#78350f', description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãŒã§ãã‚‹' },
            { name: 'GitHubé€£æºè€…', hours: 120, color: '#ef4444', description: 'ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†' },
            { name: 'ãƒ‡ãƒ—ãƒ­ã‚¤çµŒé¨“è€…', hours: 130, color: '#dc2626', description: 'ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã§ãã‚‹' },
            { name: 'èªè¨¼å®Ÿè£…è€…', hours: 140, color: '#b91c1c', description: 'ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ä½œã‚Œã‚‹' },
            { name: 'ãƒŸãƒ‹ã‚¢ãƒ—ãƒªå®Œæˆ', hours: 150, color: '#991b1b', description: 'å°ã•ãªã‚¢ãƒ—ãƒªã‚’1æœ¬å®Œæˆã•ã›ãŸ' },
            { name: 'ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯å…¥é–€', hours: 170, color: '#7f1d1d', description: 'ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒãƒƒã‚¯ã®ä¸¡æ–¹è§¦ã‚Œã‚‹' },
            { name: 'APIè¨­è¨ˆè€…', hours: 190, color: '#6366f1', description: 'è‡ªåˆ†ã§APIã‚’è¨­è¨ˆã§ãã‚‹' },
            { name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜è€…', hours: 210, color: '#4f46e5', description: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒãˆãŸå®Ÿè£…' },
            { name: 'ãƒ†ã‚¹ãƒˆæ›¸ãå§‹ã‚', hours: 230, color: '#4338ca', description: 'ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå§‹ã‚ãŸ' },
            { name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ„è­˜', hours: 250, color: '#3730a3', description: 'é€Ÿåº¦ãƒ»æœ€é©åŒ–ã‚’è€ƒãˆã‚‰ã‚Œã‚‹' },
            { name: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª1æœ¬', hours: 280, color: '#312e81', description: 'è¦‹ã›ã‚‰ã‚Œã‚‹ä½œå“ãŒ1ã¤ã‚ã‚‹' },
            { name: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª2æœ¬', hours: 320, color: '#6366f1', description: 'è¦‹ã›ã‚‰ã‚Œã‚‹ä½œå“ãŒ2ã¤ã‚ã‚‹' },
            { name: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª3æœ¬', hours: 360, color: '#818cf8', description: 'è¦‹ã›ã‚‰ã‚Œã‚‹ä½œå“ãŒ3ã¤ã‚ã‚‹' },
            { name: 'å®Ÿå‹™ãƒ¬ãƒ™ãƒ«å…¥å£', hours: 400, color: '#a78bfa', description: 'å®Ÿå‹™ã§é€šç”¨ã™ã‚‹ã‚¹ã‚­ãƒ«' },
            { name: 'ãƒãƒ¼ãƒ é–‹ç™ºçµŒé¨“', hours: 450, color: '#c4b5fd', description: 'ãƒãƒ¼ãƒ ã§ã®é–‹ç™ºã‚’çµŒé¨“' },
            { name: 'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼', hours: 500, color: '#e0e7ff', description: 'ä»–äººã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚ã‚‹' },
            { name: 'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆè¦‹ç¿’ã„', hours: 600, color: '#10b981', description: 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆãŒã§ãã‚‹' },
            { name: 'ãƒŸãƒ‰ãƒ«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', hours: 800, color: '#059669', description: 'ä¸€äººã§å®Œçµã§ãã‚‹' },
            { name: 'ã‚·ãƒ‹ã‚¢å€™è£œ', hours: 1000, color: '#047857', description: 'ãƒ¡ãƒ³ã‚¿ãƒ¼ãŒã§ãã‚‹' },
            { name: 'ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', hours: 1500, color: '#065f46', description: 'æŠ€è¡“ãƒªãƒ¼ãƒ€ãƒ¼' },
            { name: 'ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰', hours: 2000, color: '#064e3b', description: 'ãƒãƒ¼ãƒ ã‚’æŠ€è¡“é¢ã§ãƒªãƒ¼ãƒ‰' },
            { name: 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ', hours: 3000, color: '#7c3aed', description: 'ç‰¹å®šåˆ†é‡ã®ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ' }
          ];

          // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYY-MM-DDï¼‰
          const formatDate = (date) => {
            return date.toISOString().split('T')[0];
          };

          // é€±ã®é–‹å§‹æ—¥ï¼ˆæœˆæ›œæ—¥ï¼‰ã‚’å–å¾—
          const getWeekStart = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
          };

          // é€±ã®ã‚­ãƒ¼ï¼ˆYYYY-Wxxå½¢å¼ï¼‰
          const getWeekKey = (date) => {
            const weekStart = getWeekStart(date);
            return formatDate(weekStart);
          };

          // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              setUser(user);
              if (user) {
                loadUserData(user.uid);
              } else {
                setDailyRecords({});
              }
              setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
          const loadUserData = async (userId) => {
            try {
              setSyncing(true);
              const userDoc = await db.collection('users').doc(userId).get();
              
              if (userDoc.exists) {
                const data = userDoc.data();
                
                // æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆstudyHistoryï¼‰ãŒå­˜åœ¨ã—ã€æ–°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç§»è¡Œ
                if (data.studyHistory && data.studyHistory.length > 0 && !data.dailyRecords) {
                  console.log('æ—§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç§»è¡Œã—ã¾ã™...');
                  const newDailyRecords = {};
                  
                  data.studyHistory.forEach(session => {
                    const date = session.date; // "YYYY/MM/DD"å½¢å¼
                    const dateKey = date.replace(/\//g, '-'); // "YYYY-MM-DD"ã«å¤‰æ›
                    
                    if (!newDailyRecords[dateKey]) {
                      newDailyRecords[dateKey] = 0;
                    }
                    newDailyRecords[dateKey] += session.duration;
                  });
                  
                  // ç§»è¡Œã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                  await db.collection('users').doc(userId).set({
                    dailyRecords: newDailyRecords,
                    studyHistory: data.studyHistory, // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦æ®‹ã™
                    migrated: true,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  
                  setDailyRecords(newDailyRecords);
                  alert('æ—§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç§»è¡Œã—ã¾ã—ãŸï¼');
                  return;
                }
                
                // æ—¢ã«migrated35hãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (data.migrated35h) {
                  setDailyRecords(data.dailyRecords || {});
                } else {
                  // åˆå›ã®ã¿35æ™‚é–“ã‚’ä»Šæ—¥ã«è¿½åŠ 
                  const records = data.dailyRecords || {};
                  const today = formatDate(new Date());
                  records[today] = (records[today] || 0) + (35 * 3600);
                  
                  // ä¿å­˜ã—ã¦ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                  await db.collection('users').doc(userId).set({
                    dailyRecords: records,
                    migrated35h: true,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                  }, { merge: true });
                  
                  setDailyRecords(records);
                  console.log('35æ™‚é–“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                }
              } else {
                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ä½•ã‚‚ã—ãªã„
                setDailyRecords({});
              }
            } catch (error) {
              console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
              setSyncing(false);
            }
          };

          // Firestoreã«ä¿å­˜
          const saveToFirestore = async (newDailyRecords) => {
            if (!user) return;
            try {
              setSyncing(true);
              await db.collection('users').doc(user.uid).set({
                dailyRecords: newDailyRecords,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              });
            } catch (error) {
              console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
              alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
              setSyncing(false);
            }
          };

          // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
          const signInWithGoogle = async () => {
            try {
              const provider = new firebase.auth.GoogleAuthProvider();
              await auth.signInWithPopup(provider);
            } catch (error) {
              console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
            }
          };

          const signInAnonymously = async () => {
            try {
              await auth.signInAnonymously();
            } catch (error) {
              console.error('åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
            }
          };

          const signOut = async () => {
            await auth.signOut();
          };

          // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
          const startTimer = () => {
            setIsStudying(true);
            setIsPaused(false);
            setSessionStartTime(Date.now());
            setPausedTime(0);
            
            intervalRef.current = setInterval(() => {
              setCurrentSessionTime((prev) => prev + 1);
            }, 1000);
          };

          // ä¸€æ™‚åœæ­¢
          const pauseTimer = () => {
            if (isPaused) {
              setIsPaused(false);
              setSessionStartTime(Date.now() - pausedTime);
              intervalRef.current = setInterval(() => {
                setCurrentSessionTime((prev) => prev + 1);
              }, 1000);
            } else {
              setIsPaused(true);
              setPausedTime(Date.now() - sessionStartTime);
              clearInterval(intervalRef.current);
            }
          };

          // çµ‚äº†
          const stopTimer = () => {
            clearInterval(intervalRef.current);
            
            if (currentSessionTime > 0) {
              const today = formatDate(new Date());
              const newDailyRecords = { ...dailyRecords };
              
              if (!newDailyRecords[today]) {
                newDailyRecords[today] = 0;
              }
              newDailyRecords[today] += currentSessionTime;
              
              setDailyRecords(newDailyRecords);
              saveToFirestore(newDailyRecords);
            }
            
            setIsStudying(false);
            setIsPaused(false);
            setCurrentSessionTime(0);
            setSessionStartTime(null);
            setPausedTime(0);
          };

          // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆåˆ†å˜ä½ï¼‰
          const formatTime = (seconds) => {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (hrs > 0) {
              return `${hrs}h ${mins}m`;
            }
            return `${mins}m`;
          };

          // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºç”¨ï¼ˆç§’ä»˜ãï¼‰
          const formatTimerDisplay = (seconds) => {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
          };

          // åˆè¨ˆå­¦ç¿’æ™‚é–“ï¼ˆç§’ï¼‰
          const getTotalStudyTime = () => {
            return Object.values(dailyRecords).reduce((sum, time) => sum + time, 0);
          };

          // ä»Šæ—¥ã®å­¦ç¿’æ™‚é–“
          const getTodayTime = () => {
            const today = formatDate(new Date());
            return dailyRecords[today] || 0;
          };

          // æ˜¨æ—¥ã®å­¦ç¿’æ™‚é–“
          const getYesterdayTime = () => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return dailyRecords[formatDate(yesterday)] || 0;
          };

          // ä»Šé€±ã®å­¦ç¿’æ™‚é–“
          const getThisWeekTime = () => {
            const weekStart = getWeekStart(new Date());
            let total = 0;
            for (let i = 0; i < 7; i++) {
              const date = new Date(weekStart);
              date.setDate(date.getDate() + i);
              total += dailyRecords[formatDate(date)] || 0;
            }
            return total;
          };

          // å…ˆé€±ã®å­¦ç¿’æ™‚é–“
          const getLastWeekTime = () => {
            const lastWeekStart = new Date(getWeekStart(new Date()));
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            let total = 0;
            for (let i = 0; i < 7; i++) {
              const date = new Date(lastWeekStart);
              date.setDate(date.getDate() + i);
              total += dailyRecords[formatDate(date)] || 0;
            }
            return total;
          };

          // å…ˆã€…é€±ã®å­¦ç¿’æ™‚é–“
          const getTwoWeeksAgoTime = () => {
            const twoWeeksAgoStart = new Date(getWeekStart(new Date()));
            twoWeeksAgoStart.setDate(twoWeeksAgoStart.getDate() - 14);
            let total = 0;
            for (let i = 0; i < 7; i++) {
              const date = new Date(twoWeeksAgoStart);
              date.setDate(date.getDate() + i);
              total += dailyRecords[formatDate(date)] || 0;
            }
            return total;
          };

          // å¹³å‡ï¼ˆæ—¥åˆ¥ï¼‰
          const getDailyAverage = () => {
            const days = Object.keys(dailyRecords).length;
            return days > 0 ? getTotalStudyTime() / days : 0;
          };

          // å¹³å‡ï¼ˆé€±åˆ¥ï¼‰
          const getWeeklyAverage = () => {
            const weeks = new Set();
            Object.keys(dailyRecords).forEach(date => {
              weeks.add(getWeekKey(new Date(date)));
            });
            return weeks.size > 0 ? getTotalStudyTime() / weeks.size : 0;
          };

          // ãƒ¬ãƒ™ãƒ«æƒ…å ±
          const getLevelInfo = () => {
            const totalHours = getTotalStudyTime() / 3600;
            let currentLevel = engineerLevels[0];
            let nextLevel = engineerLevels[1];
            
            for (let i = 0; i < engineerLevels.length; i++) {
              if (totalHours >= engineerLevels[i].hours) {
                currentLevel = engineerLevels[i];
                nextLevel = engineerLevels[i + 1] || null;
              } else {
                break;
              }
            }
            
            const progress = nextLevel 
              ? ((totalHours - currentLevel.hours) / (nextLevel.hours - currentLevel.hours)) * 100
              : 100;
            
            return { current: currentLevel, next: nextLevel, progress };
          };

          // é€£ç¶šå­¦ç¿’æ—¥æ•°
          const getStreak = () => {
            const today = new Date();
            let streak = 0;
            for (let i = 0; i < 365; i++) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              if (dailyRecords[formatDate(date)] && dailyRecords[formatDate(date)] > 0) {
                streak++;
              } else if (i > 0) {
                break;
              }
            }
            return streak;
          };

          const totalHours = Math.floor(getTotalStudyTime() / 3600);
          const levelInfo = getLevelInfo();
          const todayTime = getTodayTime();
          const yesterdayTime = getYesterdayTime();
          const thisWeekTime = getThisWeekTime();
          const lastWeekTime = getLastWeekTime();
          const twoWeeksAgoTime = getTwoWeeksAgoTime();
          const dailyAvg = getDailyAverage();
          const weeklyAvg = getWeeklyAverage();
          const streak = getStreak();

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 flex items-center justify-center">
                <div className="text-2xl font-bold text-indigo-600">èª­ã¿è¾¼ã¿ä¸­...</div>
              </div>
            );
          }

          if (!user) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6">å­¦ç¿’ã‚¿ã‚¤ãƒãƒ¼</h1>
                  <div className="space-y-4">
                    <button
                      onClick={signInWithGoogle}
                      className="w-full bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 py-3 rounded-xl font-medium transition-colors flex items-center justify-center space-x-2"
                    >
                      <span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
                    </button>
                    <button
                      onClick={signInAnonymously}
                      className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-medium transition-colors"
                    >
                      ã‚²ã‚¹ãƒˆã§å§‹ã‚ã‚‹
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 p-4">
              <div className="max-w-6xl mx-auto space-y-6">
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="bg-white rounded-2xl shadow-lg p-6">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800">å­¦ç¿’ã‚¿ã‚¤ãƒãƒ¼</h1>
                      <p className="text-gray-600">ç¶™ç¶šã¯åŠ›ãªã‚Š ğŸ”¥</p>
                    </div>
                    <button
                      onClick={signOut}
                      className="flex items-center space-x-2 text-gray-600 hover:text-gray-800"
                    >
                      <LogOut className="w-5 h-5" />
                      <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                    </button>
                  </div>
                </div>

                {/* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒãƒ¼ */}
                <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
                  <div className="mb-6">
                    <div className="text-6xl font-mono font-bold text-gray-800 mb-4">
                      {formatTimerDisplay(currentSessionTime)}
                    </div>
                    {isStudying && (
                      <div className={`text-lg font-medium ${isPaused ? 'text-orange-600' : 'text-green-600'}`}>
                        {isPaused ? 'â¸ï¸ ä¼‘æ†©ä¸­' : 'â–¶ï¸ å­¦ç¿’ä¸­'}
                      </div>
                    )}
                  </div>

                  <div className="flex justify-center space-x-4">
                    {!isStudying ? (
                      <button
                        onClick={startTimer}
                        className="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-xl font-medium transition-colors"
                      >
                        <Play className="w-6 h-6" />
                        <span>å­¦ç¿’é–‹å§‹</span>
                      </button>
                    ) : (
                      <>
                        <button
                          onClick={pauseTimer}
                          className={`flex items-center space-x-2 px-6 py-4 rounded-xl font-medium transition-colors ${
                            isPaused 
                              ? 'bg-green-500 hover:bg-green-600 text-white' 
                              : 'bg-orange-500 hover:bg-orange-600 text-white'
                          }`}
                        >
                          {isPaused ? <Play className="w-5 h-5" /> : <Pause className="w-5 h-5" />}
                          <span>{isPaused ? 'å†é–‹' : 'ä¼‘æ†©'}</span>
                        </button>
                        <button
                          onClick={stopTimer}
                          className="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white px-6 py-4 rounded-xl font-medium transition-colors"
                        >
                          <Square className="w-5 h-5" />
                          <span>çµ‚äº†</span>
                        </button>
                      </>
                    )}
                  </div>
                </div>

                {/* ãƒ¬ãƒ™ãƒ«è¡¨ç¤º */}
                <div className="bg-white rounded-2xl shadow-lg p-6">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center space-x-3">
                      <Award className="w-6 h-6 text-indigo-600" />
                      <h2 className="text-xl font-bold text-gray-800">ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ç§°å·</h2>
                    </div>
                    <button
                      onClick={() => setShowLevelList(!showLevelList)}
                      className="text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-lg transition-colors"
                    >
                      {showLevelList ? 'é–‰ã˜ã‚‹' : 'ğŸ“œ ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹'}
                    </button>
                  </div>
                  
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <span className="text-2xl font-bold" style={{ color: levelInfo.current.color }}>
                        {levelInfo.current.name}
                      </span>
                      <p className="text-sm text-gray-600 mt-1">{levelInfo.current.description}</p>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-bold text-gray-800">{totalHours}h</div>
                      <div className="text-sm text-gray-600">ç´¯ç©æ™‚é–“</div>
                    </div>
                  </div>
                  
                  {levelInfo.next && (
                    <>
                      <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                        <div
                          className="h-3 rounded-full transition-all duration-300"
                          style={{ 
                            width: `${Math.min(levelInfo.progress, 100)}%`,
                            backgroundColor: levelInfo.current.color 
                          }}
                        ></div>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">
                          æ¬¡: <span className="font-bold" style={{ color: levelInfo.next.color }}>{levelInfo.next.name}</span>
                        </span>
                        <span className="font-bold text-indigo-600">
                          ã‚ã¨ {levelInfo.next.hours - totalHours}h
                        </span>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">ğŸ“Œ {levelInfo.next.description}</p>
                    </>
                  )}

                  {/* å…¨ãƒ¬ãƒ™ãƒ«ä¸€è¦§ */}
                  {showLevelList && (
                    <div className="mt-6 pt-6 border-t border-gray-200">
                      <h3 className="text-lg font-bold text-gray-800 mb-4">ğŸ—ºï¸ å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h3>
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {engineerLevels.map((level, index) => {
                          const isCompleted = totalHours >= level.hours;
                          const isCurrent = levelInfo.current.hours === level.hours;
                          const isNext = levelInfo.next && levelInfo.next.hours === level.hours;
                          
                          return (
                            <div
                              key={index}
                              className={`p-3 rounded-lg border-2 transition-all ${
                                isCurrent 
                                  ? 'border-indigo-500 bg-indigo-50' 
                                  : isNext
                                  ? 'border-orange-400 bg-orange-50'
                                  : isCompleted 
                                  ? 'border-green-300 bg-green-50' 
                                  : 'border-gray-200 bg-gray-50'
                              }`}
                            >
                              <div className="flex justify-between items-start">
                                <div className="flex-1">
                                  <div className="flex items-center space-x-2">
                                    {isCompleted && <span className="text-green-600">âœ…</span>}
                                    {isCurrent && <span className="text-indigo-600">ğŸ“</span>}
                                    {isNext && <span className="text-orange-600">ğŸ¯</span>}
                                    <span 
                                      className="font-bold"
                                      style={{ color: isCompleted ? level.color : '#9ca3af' }}
                                    >
                                      {level.name}
                                    </span>
                                  </div>
                                  <p className={`text-sm mt-1 ${isCompleted ? 'text-gray-700' : 'text-gray-500'}`}>
                                    {level.description}
                                  </p>
                                </div>
                                <div className="text-right ml-4">
                                  <div className={`font-bold ${isCompleted ? 'text-gray-800' : 'text-gray-400'}`}>
                                    {level.hours}h
                                  </div>
                                  {!isCompleted && level.hours > totalHours && (
                                    <div className="text-xs text-gray-500">
                                      ã‚ã¨{level.hours - totalHours}h
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>

                {/* ä»Šæ—¥ã®å®Ÿç¸¾ & é€£ç¶šæ—¥æ•° */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center space-x-3 mb-4">
                      <Calendar className="w-6 h-6 text-blue-600" />
                      <h2 className="text-xl font-bold text-gray-800">ä»Šæ—¥ã®å­¦ç¿’</h2>
                    </div>
                    <div className="text-4xl font-bold text-blue-600 mb-2">
                      {formatTime(todayTime)}
                    </div>
                    <div className="text-sm text-gray-600">
                      æ˜¨æ—¥: {formatTime(yesterdayTime)}
                      {todayTime > yesterdayTime ? (
                        <span className="text-green-600 ml-2">ğŸ“ˆ +{Math.floor((todayTime - yesterdayTime) / 60)}m</span>
                      ) : todayTime < yesterdayTime ? (
                        <span className="text-red-600 ml-2">ğŸ“‰ -{Math.floor((yesterdayTime - todayTime) / 60)}m</span>
                      ) : (
                        <span className="text-gray-600 ml-2">â¡ï¸ åŒã˜</span>
                      )}
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center space-x-3 mb-4">
                      <Flame className="w-6 h-6 text-orange-600" />
                      <h2 className="text-xl font-bold text-gray-800">é€£ç¶šå­¦ç¿’</h2>
                    </div>
                    <div className="text-4xl font-bold text-orange-600 mb-2">
                      {streak}æ—¥
                    </div>
                    <div className="text-sm text-gray-600">
                      {streak >= 7 ? 'ç´ æ™´ã‚‰ã—ã„ï¼' : streak >= 3 ? 'è‰¯ã„èª¿å­ï¼' : 'é ‘å¼µã‚ã†ï¼'}
                    </div>
                  </div>
                </div>

                {/* é€±åˆ¥æ¯”è¼ƒ */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <div className="flex items-center space-x-3 mb-4">
                    <BarChart3 className="w-6 h-6 text-purple-600" />
                    <h2 className="text-xl font-bold text-gray-800">é€±åˆ¥å­¦ç¿’æ™‚é–“</h2>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <div className="flex justify-between mb-1">
                        <span className="font-bold text-gray-800">ä»Šé€±</span>
                        <span className="font-bold text-purple-600">
                          {formatTime(thisWeekTime)}
                        </span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-3">
                        <div
                          className="h-3 rounded-full bg-purple-600"
                          style={{ width: `${Math.min((thisWeekTime / (40 * 3600)) * 100, 100)}%` }}
                        ></div>
                      </div>
                    </div>

                    <div>
                      <div className="flex justify-between mb-1">
                        <span className="text-gray-700">å…ˆé€±</span>
                        <span className="text-gray-700">
                          {formatTime(lastWeekTime)}
                          {thisWeekTime > lastWeekTime ? (
                            <span className="text-green-600 ml-2">ğŸ“ˆ</span>
                          ) : thisWeekTime < lastWeekTime ? (
                            <span className="text-red-600 ml-2">ğŸ“‰</span>
                          ) : (
                            <span className="text-gray-600 ml-2">â¡ï¸</span>
                          )}
                        </span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                          className="h-2 rounded-full bg-gray-400"
                          style={{ width: `${Math.min((lastWeekTime / (40 * 3600)) * 100, 100)}%` }}
                        ></div>
                      </div>
                    </div>

                    <div>
                      <div className="flex justify-between mb-1">
                        <span className="text-gray-700">å…ˆã€…é€±</span>
                        <span className="text-gray-700">
                          {formatTime(twoWeeksAgoTime)}
                          {lastWeekTime > twoWeeksAgoTime ? (
                            <span className="text-green-600 ml-2">ğŸ“ˆ</span>
                          ) : lastWeekTime < twoWeeksAgoTime ? (
                            <span className="text-red-600 ml-2">ğŸ“‰</span>
                          ) : (
                            <span className="text-gray-600 ml-2">â¡ï¸</span>
                          )}
                        </span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                          className="h-2 rounded-full bg-gray-300"
                          style={{ width: `${Math.min((twoWeeksAgoTime / (40 * 3600)) * 100, 100)}%` }}
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* å¹³å‡å­¦ç¿’æ™‚é–“ */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-white rounded-xl shadow-lg p-6 text-center">
                    <Clock className="w-8 h-8 text-blue-500 mx-auto mb-2" />
                    <div className="text-2xl font-bold text-gray-800">
                      {formatTime(dailyAvg)}
                    </div>
                    <div className="text-sm text-gray-600">1æ—¥å¹³å‡å­¦ç¿’æ™‚é–“</div>
                  </div>
                  
                  <div className="bg-white rounded-xl shadow-lg p-6 text-center">
                    <TrendingUp className="w-8 h-8 text-green-500 mx-auto mb-2" />
                    <div className="text-2xl font-bold text-gray-800">
                      {formatTime(weeklyAvg)}
                    </div>
                    <div className="text-sm text-gray-600">1é€±é–“å¹³å‡å­¦ç¿’æ™‚é–“</div>
                  </div>
                </div>

                {/* ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
                <div className="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg p-6 text-white text-center">
                  <div className="text-xl font-bold mb-2">
                    {streak >= 30 ? 'ğŸ† ç¶™ç¶šã®ç‹è€…ï¼' : 
                     streak >= 14 ? 'ğŸ”¥ ç¶™ç¶šåŠ›ãŒç´ æ™´ã‚‰ã—ã„ï¼' :
                     streak >= 7 ? 'ğŸ’ª 1é€±é–“ç¶™ç¶šé”æˆï¼' :
                     streak >= 3 ? 'ğŸ‘ è‰¯ã„ãƒšãƒ¼ã‚¹ï¼' :
                     'ğŸš€ ä»Šæ—¥ã‚‚é ‘å¼µã‚ã†ï¼'}
                  </div>
                  <div className="text-sm opacity-90">
                    {todayTime === 0 ? 'ä»Šæ—¥ã®å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼' :
                     todayTime > yesterdayTime ? 'æ˜¨æ—¥ã‚ˆã‚Šæˆé•·ã—ã¦ã„ã‚‹ï¼' :
                     'ç¶™ç¶šãŒåŠ›ã«ãªã‚‹ï¼'}
                  </div>
                </div>

                {syncing && (
                  <div className="text-center text-blue-600 text-sm">
                    â˜ï¸ åŒæœŸä¸­...
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<StudyTimerApp />, document.getElementById('root'));
    </script>
</body>
</html>
